scenario_id: conversation_history_existing_ticket_001
description: Existing ticket - conversation appended to history (negative ticket_id)
category: conversation-history
created: '2026-02-03'
input:
  email:
    subject: "Re: Problem z drukarką SN11111"
    body: "Nadal nie działa po restarcie"
    from: "customer@example.com"
    received: '2026-02-03T15:30:00Z'
  mock_function_responses:
    check_warranty:
      status: valid
      warranty_type: service_contract
      expires: '2026-08-15'
      device_name: RICOH SP 330DN
      serial: SN11111
      klient_id: 555
    create_ticket:
      ticket_id: "-9001"  # Negative = existing ticket
      status: found
    check_agent_disabled:
      posiada_ceche: false  # AI agent is enabled
    send_email:
      message_id: msg-history-002
      status: sent
    append_ticket_history:
      status: stored
expected_output:
  scenario_instruction_used: steps:store-agent-message
  processing_time_ms: 80000
  expected_function_calls:
  - function_name: check_warranty
    arguments:
      serial_number: SN11111
    result_contains:
      status: valid
  - function_name: create_ticket
    arguments_contain:
      serial_number: SN11111
      customer_email: customer@example.com
      issue_description: "Nadal nie działa po restarcie"
    result_contains:
      ticket_id: "-9001"
  - function_name: check_agent_disabled
    arguments:
      zadanie_id: 9001  # Absolute value
    result_contains:
      posiada_ceche: false
  - function_name: send_email
    arguments_contain:
      to: customer@example.com
  - function_name: append_ticket_history
    arguments_contain:
      ticket_id: "-9001"
      sender: CLIENT
      message: "Nadal nie działa po restarcie"
  - function_name: append_ticket_history
    arguments_contain:
      ticket_id: "-9001"
      sender: AGENT
    message_contains:
    - "Potwierdzamy przyjęcie zgłoszenia"
  expected_steps:
  - extract-serial
  - check-warranty
  - valid-warranty
  - send-confirmation
  - store-client-message
  - store-agent-message
  workflow_outcome:
    history_appended: true
    existing_ticket: true
    email_sent: true
